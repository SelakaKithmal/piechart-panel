{"version":3,"sources":["../src/piechart_ctrl.js"],"names":["PieChartCtrl","$scope","$injector","$rootScope","hiddenSeries","panelDefaults","pieType","legend","show","values","links","datasource","maxDataPoints","interval","targets","cacheTimeout","nullPointMode","legendType","breakPoint","aliasColors","format","valueName","strokeWidth","fontSize","combine","threshold","label","_","defaults","panel","events","on","onRender","bind","onDataReceived","onDataError","onInitEditMode","setLegendWidthForLegacyBrowser","addEditorTab","unitFormats","kbn","getUnitFormats","subItem","value","render","series","color","alias","data","parseSeries","map","serie","i","stats","colors","legendData","dataList","seriesHandler","seriesData","TimeSeries","datapoints","target","flotpairs","getFlotPairs","isNumber","decimals","scaledDecimals","delta","dec","Math","floor","log","LN10","magn","pow","norm","size","result","max","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","scope","elem","attrs","ctrl","isIE11","window","MSInputMethodContext","document","documentMode","sideWidth","MetricsPanelCtrl","templateUrl"],"mappings":"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","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\nimport rendering from './rendering';\nimport legend from './legend';\n\nexport class PieChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n    this.hiddenSeries = {};\n\n    var panelDefaults = {\n      pieType: 'pie',\n      legend: {\n        show: true, // disable/enable legend\n        values: true\n      },\n      links: [],\n      datasource: null,\n      maxDataPoints: 3,\n      interval: null,\n      targets: [{}],\n      cacheTimeout: null,\n      nullPointMode: 'connected',\n      legendType: 'Under graph',\n      breakPoint: '50%',\n      aliasColors: {},\n      format: 'short',\n      valueName: 'current',\n      strokeWidth: 1,\n      fontSize: '80%',\n      combine: {\n        threshold: 0.0,\n        label: 'Others'\n      }\n    };\n\n    _.defaults(this.panel, panelDefaults);\n    _.defaults(this.panel.legend, panelDefaults.legend);\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n\n    this.setLegendWidthForLegacyBrowser();\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-piechart-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.render();\n  }\n\n  onDataError() {\n    this.series = [];\n    this.render();\n  }\n\n  changeSeriesColor(series, color) {\n    series.color = color;\n    this.panel.aliasColors[series.alias] = series.color;\n    this.render();\n  }\n\n  onRender() {\n    this.data = this.parseSeries(this.series);\n  }\n\n  parseSeries(series) {\n    return _.map(this.series, (serie, i) => {\n      return {\n        label: serie.alias,\n        data: serie.stats[this.panel.valueName],\n        color: this.panel.aliasColors[serie.alias] || this.$rootScope.colors[i],\n        legendData: serie.stats[this.panel.valueName],\n      };\n    });\n  }\n\n  onDataReceived(dataList) {\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.data = this.parseSeries(this.series);\n    this.render(this.data);\n  }\n\n  seriesHandler(seriesData) {\n    var series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec);\n    var norm = delta / magn; // norm is between 1.0 and 10.0\n    var size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) { dec = 0; }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  formatValue(value) {\n    var decimalInfo = this.getDecimalsForValue(value);\n    var formatFunc = kbn.valueFormats[this.panel.format];\n    if (formatFunc) {\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    }\n    return value;\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    rendering(scope, elem, attrs, ctrl);\n  }\n\n  toggleSeries(serie) {\n    if (this.hiddenSeries[serie.label]) {\n      delete this.hiddenSeries[serie.label];\n    } else {\n      this.hiddenSeries[serie.label] = true;\n    }\n    this.render();\n  }\n\n  onLegendTypeChanged() {\n    this.setLegendWidthForLegacyBrowser();\n    this.render();\n  }\n\n  setLegendWidthForLegacyBrowser() {\n    var isIE11 = !!window.MSInputMethodContext && !!document.documentMode;\n    if (isIE11 && this.panel.legendType === 'Right side' && !this.panel.legend.sideWidth) {\n      this.panel.legend.sideWidth = 150;\n    }\n  }\n}\n\nPieChartCtrl.templateUrl = 'module.html';\n"],"file":"piechart_ctrl.js"}